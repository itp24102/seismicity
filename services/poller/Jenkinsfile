pipeline {
    agent any

    environment {
        IMAGE = "ghcr.io/itp24102/poller:latest"
        GITHUB_USER = "itp24102"
        GITHUB_PAT = credentials('ghcr-pat')
    }

    stages {
        stage('Build') {
            steps {
                script {
                    docker.build("${IMAGE}", "--file services/poller/Dockerfile services/poller")
                }
            }
        }

        stage('Push') {
            steps {
                script {
                    docker.withRegistry('https://ghcr.io', 'ghcr-pat') {
                        docker.image("${IMAGE}").push()
                    }
                }
            }
        }
    }
}
