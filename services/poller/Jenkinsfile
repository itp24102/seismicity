pipeline {
    agent {
        kubernetes {
            yamlFile 'jenkins/pod.yaml'
            defaultContainer 'python'
        }
    }

    environment {
        AWS_DEFAULT_REGION = 'eu-west-1'
        S3_BUCKET = 'seismicity-app-bucket'
        FUNCTION_NAME = 'seismicity-function'
        INF_URL = 'http://seismicity.westeurope.cloudapp.azure.com:8086'
        INF_TOKEN = credentials('influxdb-token')
    }

    stages {
        stage('Install dependencies') {
            steps {
                dir('services/poller') {
                    container('python') {
                        sh 'pip install --target build/ -r requirements.txt'
                        sh 'cp src/poll_seismic.py build/'
                    }
                }
            }
        }

        stage('Package') {
            steps {
                dir('services/poller/build') {
                    container('python') {
                        sh 'zip -r ../function.zip .'
                    }
                }
            }
        }

        stage('Upload to S3') {
            steps {
                dir('services/poller') {
                    container('awscli') {
                        withCredentials([[
                            $class: 'AmazonWebServicesCredentialsBinding',
                            credentialsId: 'aws-credentials'
                        ]]) {
                            sh 'aws s3 cp function.zip s3://seismicity-app-bucket/function.zip --region eu-west-1'
                        }
                    }
                }
            }
        }

        stage('Apply Infrastructure with OpenTofu') {
            steps {
                dir('infrastructure/opentofu/aws') {
                    container('python') {
                        withCredentials([[
                            $class: 'AmazonWebServicesCredentialsBinding',
                            credentialsId: 'aws-credentials'
                        ]]) {
                            sh '''
                                curl -LO https://github.com/opentofu/opentofu/releases/download/v1.9.1/tofu_1.9.1_linux_amd64.zip
                                unzip -q tofu_1.9.1_linux_amd64.zip
                                install -o root -g root -m 0755 tofu /usr/local/bin/tofu
                                cp ../../../services/poller/function.zip .
                                cp ../../../services/influx-writer/influx_writer.zip . || true
                                tofu init
                                tofu apply -auto-approve -var=influx_url=$INF_URL -var=influx_token=$INF_TOKEN
                            '''
                        }
                    }
                }
            }
        }
    }

    post {
        failure {
            echo '❌ Κάποιο στάδιο απέτυχε.'
        }
    }
}
