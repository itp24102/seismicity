pipeline {
  agent any

  environment {
    FUNCTION_NAME = "seismicity-function"
  }

  stages {
    stage('Build') {
      steps {
        dir('services/poller') {
          sh 'pip install --target build/ -r requirements.txt'
          sh 'cp src/handler.py build/'
        }
      }
    }

    stage('Package') {
      steps {
        dir('services/poller/build') {
          sh 'zip -r ../function.zip .'
        }
      }
    }

    stage('Deploy to AWS') {
      steps {
        dir('services/poller') {
          withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-credentials']]) {
            sh 'aws lambda update-function-code --function-name $FUNCTION_NAME --zip-file fileb://function.zip --region eu-west-1'
          }
        }
      }
    }
  }

  post {
    failure {
      echo '❌ Κάποιο στάδιο απέτυχε.'
    }
  }
}
